# ==========================================
# Home Assistant Package: é›·ç¥åŠ é€Ÿå™¨è‡ªåŠ¨æš‚åœ
# ä½œè€…: https://github.com/jacob2826/
# æè¿°: å½“æŒ‡å®šçš„ PC/ä¸»æœºç¦»çº¿æ—¶ï¼Œè‡ªåŠ¨æš‚åœé›·ç¥åŠ é€Ÿå™¨æ—¶é•¿ã€‚
# ==========================================

# ==========================================
# 1. æ ¸å¿ƒç»„ä»¶ï¼šè´¦å·çŠ¶æ€ä¼ æ„Ÿå™¨
# ==========================================
sensor:
  - platform: rest
    name: "Leishen Account Info"
    resource: "https://webapi.leigod.com/api/user/info"
    method: POST
    # Payload å­˜å‚¨åœ¨ secrets.yaml ä¸­ä»¥ä¿æŠ¤ Token å®‰å…¨
    payload: !secret leishen_api_payload
    # é»˜è®¤å€¼è®¾ä¸º -1 é˜²æ­¢åˆå§‹åŒ–æœŸé—´æŠ¥é”™
    value_template: "{{ value_json.code | default(-1) }}"
    json_attributes:
      - msg
    # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡çŠ¶æ€ (èµ·åˆ° Token ä¿æ´»ä½œç”¨)
    scan_interval: 3600
    headers:
      Content-Type: "application/json"
      User-Agent: "Mozilla/5.0 (Home Assistant)"

# ==========================================
# 2. åŠ¨ä½œå®šä¹‰ï¼šæš‚åœæ¥å£
# ==========================================
rest_command:
  leishen_execute_pause:
    url: "https://webapi.leigod.com/api/user/pause"
    method: POST
    payload: !secret leishen_api_payload
    content_type: 'application/json'
    headers:
      User-Agent: "Go-http-client/1.1"

# ==========================================
# 3. è‡ªåŠ¨åŒ–é€»è¾‘
# ==========================================
automation:
  # ----------------------------------------
  # è‡ªåŠ¨åŒ– A: è®¾å¤‡ç¦»çº¿ -> è‡ªåŠ¨æš‚åœ (å«é‡è¯• & Pushoveré€šçŸ¥)
  # ----------------------------------------
  - alias: "Leishen: Auto Pause Logic"
    id: 'leishen_auto_pause_logic'
    mode: restart
    trigger:
      - platform: state
        # ç¡®ä¿ä½ å·²ç»åœ¨ HA ç•Œé¢ä¸­åˆ›å»ºäº†è¿™ä¸ª Ping ä¼ æ„Ÿå™¨
        entity_id: binary_sensor.leishen_box
        from: "on"
        to: "off"
        for: "00:05:00"
    action:
      - repeat:
          count: 5
          sequence:
            # 1. æ‰§è¡Œæš‚åœå‘½ä»¤
            - service: rest_command.leishen_execute_pause
              response_variable: pause_resp
            
            # 2. è§£æè¿”å›ç 
            - variables:
                resp_code: "{{ pause_resp.content.code | default(-999) | int }}"
                resp_msg: "{{ pause_resp.content.msg | default('APIè¯·æ±‚å¤±è´¥') }}"

            # 3. åˆ¤æ–­ç»“æœ
            - choose:
                # æˆåŠŸ (0) æˆ– å·²æš‚åœ (400803)
                - conditions:
                    - condition: template
                      value_template: "{{ resp_code in [0, 400803] }}"
                  sequence:
                    - service: notify.pushover
                      data:
                        title: "é›·ç¥åŠ é€Ÿå™¨"
                        message: >
                          {% if resp_code == 0 %}
                          âœ… æš‚åœæˆåŠŸï¼è®¾å¤‡å·²ç¦»çº¿ã€‚
                          {% else %}
                          ğŸ‘Œ æ— éœ€æ“ä½œï¼Œè´¦å·å·²å¤„äºæš‚åœçŠ¶æ€ã€‚
                          {% endif %}
                    - stop: "æš‚åœæˆåŠŸï¼Œé€€å‡ºå¾ªç¯"

                # å¤±è´¥ -> è®°å½•æ—¥å¿—å¹¶é‡è¯•
                - conditions:
                    - condition: template
                      value_template: "{{ true }}" # å…œåº•å…¶ä»–æ‰€æœ‰é”™è¯¯ç 
                  sequence:
                    - service: system_log.write
                      data:
                        message: "é›·ç¥æš‚åœå¤±è´¥ (ç¬¬ {{ repeat.index }} æ¬¡): {{ resp_msg }} (Code: {{ resp_code }})"
                    
                    # æ£€æŸ¥æ˜¯å¦æ˜¯æœ€åä¸€æ¬¡å°è¯•
                    - if:
                        - condition: template
                          value_template: "{{ repeat.index == 5 }}"
                      then:
                        - service: notify.pushover
                          data:
                            priority: 1  # é«˜ä¼˜å…ˆçº§é€šçŸ¥
                            title: "âŒ é›·ç¥æš‚åœå¤±è´¥"
                            message: "å·²é‡è¯•5æ¬¡ï¼Œæ“ä½œå¤±è´¥ã€‚æœ€åé”™è¯¯: {{ resp_msg }}"
                      else:
                        - delay: "00:00:30"

  # ----------------------------------------
  # è‡ªåŠ¨åŒ– B: Token å¤±æ•ˆæŠ¥è­¦
  # ----------------------------------------
  - alias: "Leishen: Token Invalid Alert"
    id: 'leishen_token_alert'
    mode: queued
    trigger:
      - platform: state
        entity_id: sensor.leishen_account_info
        # å¢åŠ  5ç§’ é˜²æŠ–åŠ¨ï¼Œå¿½ç•¥ HA é‡å¯ç¬é—´çš„çŠ¶æ€è·³å˜
        for: "00:00:05"
    condition:
      # ä»…å½“çŠ¶æ€æœ‰æ•ˆä¸”ä¸æ˜¯â€œæˆåŠŸ/æ­£å¸¸â€ä»£ç æ—¶æ‰æŠ¥è­¦
      - condition: template
        value_template: >
          {% set s = trigger.to_state.state if (trigger.to_state is defined and trigger.to_state) else '0' %}
          {{ s is defined and s | length > 0 and s not in ['0', '400803', 'unavailable', 'unknown', 'none'] }}
    action:
      # 1. è®°å½•ç³»ç»Ÿé”™è¯¯æ—¥å¿—
      - service: system_log.write
        data:
          message: >
            {% set new_state = trigger.to_state.state if (trigger.to_state is defined and trigger.to_state) else 'æ‰‹åŠ¨è§¦å‘/æœªçŸ¥' %}
            {% set old_state = trigger.from_state.state if (trigger.from_state is defined and trigger.from_state) else 'æœªçŸ¥' %}
            ğŸš¨ é›·ç¥æŠ¥è­¦è§¦å‘ï¼Token/API å¼‚å¸¸: {{ new_state }} (æ—§çŠ¶æ€: {{ old_state }})
      
      # 2. å‘é€é«˜ä¼˜å…ˆçº§é€šçŸ¥
      - service: notify.pushover
        data:
          priority: 1
          title: "âš ï¸ é›·ç¥ Token å¤±æ•ˆ"
          message: >
            {% set new_state = trigger.to_state.state if (trigger.to_state is defined and trigger.to_state) else 'æ‰‹åŠ¨è§¦å‘/æœªçŸ¥' %}
            æ¥å£è¿”å›é”™è¯¯ç : {{ new_state }}ï¼Œè¯·æ£€æŸ¥ Tokenã€‚
