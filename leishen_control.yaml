# ==============================================================================
# Home Assistant Package: Leishen Accelerator Auto Pause (ARP Edition)
# Author: Jacob & Gemini
# GitHub: https://github.com/jacob2826/Home-Assistant-Leishen-Auto-Pause
# Description: 
#   è‡ªåŠ¨æ£€æµ‹é›·ç¥åŠ é€Ÿå™¨ç›’å­çš„åœ¨çº¿çŠ¶æ€ï¼Œå¹¶åœ¨è®¾å¤‡ç¦»çº¿ï¼ˆå…³æœº/æ‹”çº¿ï¼‰çº¦1åˆ†é’Ÿå†…è‡ªåŠ¨æš‚åœæ—¶é•¿ã€‚
#   é‡‡ç”¨ ARP ç‰©ç†å±‚æ£€æµ‹æ–¹æ¡ˆï¼Œå®Œç¾è§£å†³è®¾å¤‡â€œç¦Pingâ€æˆ–â€œç«¯å£å…¨å…³â€å¯¼è‡´æ— æ³•æ£€æµ‹çš„é—®é¢˜ã€‚
# ==============================================================================

# ------------------------------------------------------------------------------
# 1. æ ¸å¿ƒç»„ä»¶ï¼šé›·ç¥è´¦å·çŠ¶æ€ç›‘æ§
#    åŠŸèƒ½ï¼šå®šæ—¶è·å–è´¦å·çŠ¶æ€ç ï¼Œç”¨äºåˆ¤æ–­ Token æ˜¯å¦å¤±æ•ˆæˆ–è´¦å·æ˜¯å¦å·²æš‚åœã€‚
# ------------------------------------------------------------------------------
sensor:
  - platform: rest
    name: "Leishen Account Info"
    resource: "https://webapi.leigod.com/api/user/info"
    method: POST
    # å¼•ç”¨ secrets.yaml ä¸­çš„ payloadï¼Œä¿æŠ¤éšç§
    payload: !secret leishen_api_payload
    value_template: "{{ value_json.code | default(-1) }}"
    json_attributes:
      - msg
    scan_interval: 3600
    headers:
      Content-Type: "application/json"
      User-Agent: "Mozilla/5.0 (Home Assistant)"

# ------------------------------------------------------------------------------
# 2. æ ¸å¿ƒç»„ä»¶ï¼šæé€Ÿåœ¨çº¿æ£€æµ‹ (ARP ç‰©ç†å±‚æ£€æµ‹)
#    åŸç†ï¼šå‘è®¾å¤‡å‘é€ Ping åŒ…è¯±å‘ ARP è¯·æ±‚ï¼Œéšå³æ£€æŸ¥ç³»ç»Ÿåº•å±‚ ARP ç¼“å­˜è¡¨ã€‚
#    ä¼˜åŠ¿ï¼šæ— éœ€è®¾å¤‡å“åº” ICMP (Ping) æˆ–å¼€æ”¾ TCP ç«¯å£ï¼Œåªè¦ç‰©ç†è¿æ¥å­˜åœ¨å³å¯æ£€æµ‹ã€‚
# ------------------------------------------------------------------------------
command_line:
  - binary_sensor:
      name: "Leishen Box Presence"
      unique_id: leishen_box_arp_monitor
      # [é…ç½®è¯´æ˜] è¯·å°†ä¸‹æ–¹çš„ 192.168.x.x æ›¿æ¢ä¸ºæ‚¨åŠ é€Ÿå™¨ç›’å­çš„çœŸå® IP åœ°å€
      # æ³¨æ„ï¼šcommand ä¸­æœ‰ä¸¤å¤„éœ€è¦æ›¿æ¢ IP
      command: "ping -c 1 -W 1 192.168.x.x > /dev/null 2>&1; ip neigh show 192.168.x.x | grep -q 'lladdr' && echo on || echo off"
      payload_on: "on"
      payload_off: "off"
      # æ£€æµ‹é¢‘ç‡ï¼š15ç§’ (æä½è´Ÿè½½ï¼Œä¿è¯ç§’çº§å“åº”)
      scan_interval: 15
      icon: mdi:ethernet-cable

# ------------------------------------------------------------------------------
# 3. åŠ¨ä½œå®šä¹‰ï¼šè°ƒç”¨é›·ç¥æš‚åœæ¥å£
# ------------------------------------------------------------------------------
rest_command:
  leishen_execute_pause:
    url: "https://webapi.leigod.com/api/user/pause"
    method: POST
    payload: !secret leishen_api_payload
    content_type: 'application/json'
    headers:
      User-Agent: "Go-http-client/1.1"

# ------------------------------------------------------------------------------
# 4. è‡ªåŠ¨åŒ–é€»è¾‘
# ------------------------------------------------------------------------------
automation:
  # ----------------------------------------
  # è‡ªåŠ¨åŒ– A: è®¾å¤‡ç¦»çº¿ -> è‡ªåŠ¨æš‚åœ
  # ----------------------------------------
  - alias: "Leishen: Auto Pause Logic (ARP Fast)"
    id: 'leishen_auto_pause_logic'
    mode: restart
    trigger:
      - platform: state
        entity_id: binary_sensor.leishen_box_presence
        from: "on"
        to: "off"
        # [é˜²æŠ–è®¾å®š] 45ç§’
        # ARPç¼“å­˜é€šå¸¸æœ‰çŸ­æš‚å»¶è¿Ÿï¼Œé…åˆ15sæ£€æµ‹å‘¨æœŸï¼Œ45sè¶³ä»¥ç¡®è®¤è®¾å¤‡çœŸçš„ç¦»çº¿
        for: "00:00:45"
    action:
      - repeat:
          count: 5
          sequence:
            # 1. æ‰§è¡Œæš‚åœ API
            - service: rest_command.leishen_execute_pause
              response_variable: pause_resp
            
            # 2. è§£æè¿”å›ç»“æœ
            - variables:
                resp_code: "{{ pause_resp.content.code | default(-999) | int }}"
                resp_msg: "{{ pause_resp.content.msg | default('APIè¯·æ±‚é”™è¯¯') }}"

            # 3. åˆ¤æ–­ä¸é€šçŸ¥
            - choose:
                # æƒ…å†µ1: æš‚åœæˆåŠŸ (0) æˆ– æœ¬æ¥å°±æ˜¯æš‚åœçŠ¶æ€ (400803)
                - conditions:
                    - condition: template
                      value_template: "{{ resp_code in [0, 400803] }}"
                  sequence:
                    # [é…ç½®è¯´æ˜] è¯·ä¿®æ”¹ä¸ºæ‚¨è‡ªå·±çš„é€šçŸ¥æœåŠ¡ï¼Œå¦‚ notify.mobile_app_xxx
                    - service: notify.pushover
                      data:
                        title: "é›·ç¥åŠ é€Ÿå™¨"
                        message: >
                          {% if resp_code == 0 %}
                          âœ… è®¾å¤‡å·²ç¦»çº¿ï¼Œæš‚åœæˆåŠŸï¼
                          {% else %}
                          ğŸ‘Œ è®¾å¤‡å·²ç¦»çº¿ï¼Œè´¦å·å·²å¤„äºæš‚åœçŠ¶æ€ã€‚
                          {% endif %}
                    - stop: "æ“ä½œæˆåŠŸï¼Œç»“æŸå¾ªç¯"

                # æƒ…å†µ2: å¤±è´¥ï¼Œå†™å…¥æ—¥å¿—å¹¶é‡è¯•
                - conditions:
                    - condition: template
                      value_template: "{{ true }}"
                  sequence:
                    - service: system_log.write
                      data:
                        message: "é›·ç¥æš‚åœå¤±è´¥ (ç¬¬{{ repeat.index }}æ¬¡): {{ resp_msg }} (Code: {{ resp_code }})"
                    
                    # å¦‚æœæ˜¯æœ€åä¸€æ¬¡å°è¯•ä¾ç„¶å¤±è´¥ï¼Œå‘é€é«˜ä¼˜å…ˆçº§æŠ¥è­¦
                    - if:
                        - condition: template
                          value_template: "{{ repeat.index == 5 }}"
                      then:
                        - service: notify.pushover
                          data:
                            priority: 1
                            title: "âŒ é›·ç¥æš‚åœå¤±è´¥"
                            message: "å·²é‡è¯•5æ¬¡ï¼Œæ“ä½œå¤±è´¥ã€‚æœ€åé”™è¯¯: {{ resp_msg }}"
                      else:
                        - delay: "00:00:30"

  # ----------------------------------------
  # è‡ªåŠ¨åŒ– B: Token å¤±æ•ˆ/å¼‚å¸¸æ£€æµ‹
  # ----------------------------------------
  - alias: "Leishen: Token Invalid Alert"
    id: 'leishen_token_alert'
    mode: queued
    trigger:
      - platform: state
        entity_id: sensor.leishen_account_info
        for: "00:00:05"
    condition:
      # ç™½åå•è¿‡æ»¤ï¼šåªæœ‰å‡ºç°å¼‚å¸¸çŠ¶æ€ç æ‰æŠ¥è­¦
      - condition: template
        value_template: >
          {% set s = trigger.to_state.state if (trigger.to_state is defined and trigger.to_state) else '0' %}
          {{ s is defined and s | length > 0 and s not in ['0', '400803', 'unavailable', 'unknown', 'none'] }}
    action:
      - service: system_log.write
        data:
          message: "é›·ç¥Tokenå¼‚å¸¸: {{ trigger.to_state.state }}"
      - service: notify.pushover
        data:
          priority: 1
          title: "âš ï¸ é›·ç¥ Token å¤±æ•ˆ"
          message: "æ¥å£è¿”å›é”™è¯¯ç : {{ trigger.to_state.state }}ï¼Œè¯·æ›´æ–° secrets.yaml ä¸­çš„ Tokenã€‚"
